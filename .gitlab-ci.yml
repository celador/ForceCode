image: node:10.15.3

stages:
  - install
  - build
  - package
  - release

cache:
  key: fcCache
  untracked: true

installDependencies:
  stage: install
  only:
    changes:
      - package.json
  tags:
    - docker
  script:
    - npm install --unsafe-perm
  cache:
    key: fcCache
    untracked: true

buildFC:
  stage: build
  tags:
    - docker
  script:
    - npm run build
  cache:
    key: fcCache
    untracked: true

packageFC:
  stage: package
  only:
    changes:
      - package.json
  tags:
    - docker
  script:
    - npm run package
  cache:
    key: fcCache
    untracked: true
  artifacts:
    name: '$CI_COMMIT_TITLE'
    paths:
      - '*.vsix'

releaseFC:
  stage: release
  only:
    refs:
      - master
    changes:
      - package.json
  tags:
    - docker
  cache:
    key: fcCache
    untracked: true
    policy: pull
  script:
    - $(npm bin)/vsce publish -p $VSC_PUBKEY
